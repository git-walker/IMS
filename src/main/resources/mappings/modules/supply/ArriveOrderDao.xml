<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.rootyu.rad.modules.supply.dao.ArriveOrderDao">

	<sql id="arriveOrderColumns">
		ao.id,
		ao.varrordercode,
		ao.dreceivedate,
		ao.cbiztype,
		ao.cvendormangid,
		ao.cemployeeid,
		ao.cdeptid,
		ao.ctransmodeid,
		ao.creceivepsn,
		ao.cstoreorganization,
		ao.bisback,
		ao.vbackreasonh,
		ao.vmemo,
		ao.coperator,
		ao.tmaketime,
		ao.cauditpsn,
		ao.taudittime,
		ao.pk_corp,
		ao.ibillstatus,
		ao.receiveflag,
		ao.inf_qc_date,
		ao.pk_zjmanage,
		ao.zjsign_state,
		ao.zjdate,
		ao.pk_rkmanage,
		ao.rksign_state,
		ao.rkdate,
		ao.hclosed,
		ao.create_by AS "createBy.id",
		ao.create_date,
		ao.update_by AS "updateBy.id",
		ao.update_date,
		ao.remarks,
		ao.del_flag
		<if test="cg != null">
			,
			cg.name AS "cg.name"
		</if>
		<if test="sh != null">
			,
			sh.name AS "sh.name"
		</if>
		<if test="zj != null">
			,
			zj.name AS "zj.name"
		</if>
		<if test="rk != null">
			,
			rk.name AS "rk.name"
		</if>
		<if test="createBy != null">
			,
			createBy.name AS "createBy.name"
		</if>
		<if test="cmd != null and cbd != null">
			,
			cbd.custcode AS "cbd.custcode",
			cbd.custname AS "cbd.custname",
			cbd.custshortname AS "cbd.custshortname"
		</if>
	</sql>
	
	<sql id="arriveOrderJoins">
		<if test="cg != null">
			LEFT JOIN 
				(
					SELECT 
						id,
						name 
					FROM sys_user
					WHERE 1 = 1
					<if test="cg.delFlag != null and cg.delFlag != ''">
						AND del_flag = #{cg.delFlag}
					</if>
				) cg 
			ON cg.id = ao.cemployeeid
		</if>
		<if test="sh != null">
			LEFT JOIN 
				(
					SELECT 
						id,
						name 
					FROM sys_user
					WHERE 1 = 1
					<if test="sh.delFlag != null and sh.delFlag != ''">
						AND del_flag = #{sh.delFlag}
					</if>
				) sh 
			ON sh.id = ao.creceivepsn
		</if>
		<if test="zj != null">
			LEFT JOIN 
				(
					SELECT 
						id,
						name 
					FROM sys_user
					WHERE 1 = 1
					<if test="zj.delFlag != null and zj.delFlag != ''">
						AND del_flag = #{zj.delFlag}
					</if>
				) zj 
			ON zj.id = ao.pk_zjmanage
		</if>
		<if test="rk != null">
			LEFT JOIN 
				(
					SELECT 
						id,
						name 
					FROM sys_user
					WHERE 1 = 1
					<if test="rk.delFlag != null and rk.delFlag != ''">
						AND del_flag = #{rk.delFlag}
					</if>
				) rk 
			ON rk.id = ao.pk_rkmanage
		</if>
		<if test="createBy != null">
			LEFT JOIN 
				(
					SELECT 
						id,
						name 
					FROM sys_user
					WHERE 1 = 1
					<if test="createBy.delFlag != null and createBy.delFlag != ''">
						AND del_flag = #{createBy.delFlag}
					</if>
				) createBy 
			ON createBy.id = ao.create_by
		</if>
		<if test="cmd != null and cbd != null">
			LEFT JOIN 
				(
					SELECT
						cmdt.id,
						cbdt.custcode,
						cbdt.custname,
						cbdt.custshortname
					FROM llm_cumandoc cmdt
					JOIN llm_cubasdoc cbdt ON cbdt.id = cmdt.pk_cubasdoc
					<if test="cbd.delFlag != null and cbd.delFlag != ''">
						AND cbdt.del_flag = #{cbd.delFlag}
					</if>
					WHERE 1 = 1
					<if test="cmd.delFlag != null and cmd.delFlag != ''">
						AND cmdt.del_flag = #{cmd.delFlag}
					</if>
				) cbd 
			ON cbd.id = ao.cvendormangid
		</if>
	</sql>
	
	<sql id="arriveOrderBColumns">
		aob.id,
		aob.carriveorderid,
		aob.cbaseid,
		aob.cmangid,
		aob.blargess,
		aob.blargessuprow,
		aob.narrvnum,
		aob.nelignum,
		aob.nnotelignum,
		aob.cwarehouseid,
		aob.vproducenum,
		aob.csourcebillid,
		aob.csourcebillrowid,
		aob.cprojectid,
		aob.crowno,
		aob.naccumwarehousenum,
		aob.nprice,
		aob.nmoney,
		aob.invstatus,
		aob.overstocknum,
		aob.overstockflag,
		aob.now_ninnum,
		aob.create_by AS "createBy.id",
		aob.create_date,
		aob.update_by AS "updateBy.id",
		aob.update_date,
		aob.remarks,
		aob.del_flag
		<if test="ibd != null">
			,
			ibd.id AS "ibd.id",
			ibd.invcode AS "ibd.invcode",
			ibd.invname AS "ibd.invname",
			ibd.invspec AS "ibd.invspec",
			ibd.invtype AS "ibd.invtype",
			ibd.pk_measdoc AS "ibd.pkMeasdoc"
			<if test="ibd.md != null">
				,
				md.id AS "ibd.md.id",
				md.measname AS "ibd.md.measname"
			</if>
		</if>
		<if test="imd != null">
			,
			imd.id AS "imd.id",
			imd.pk_invbasdoc AS "imd.pkInvbasdoc",
			imd.serialmanaflag AS "imd.serialmanaflag",
			imd.wholemanaflag AS "imd.wholemanaflag",
			imd.instancyflag AS "imd.instancyflag"
		</if>
		<if test="sd != null">
			,
			sd.id AS "sd.id",
			sd.storcode AS "sd.storcode",
			sd.storname AS "sd.storname",
			sd.pk_reservoirid AS "sd.pkReservoirid"
		</if>
	</sql>
	
	<sql id="arriveOrderBJoins">
		<if test="ibd != null">
			JOIN llm_invbasdoc ibd ON ibd.id = aob.cbaseid
			<if test="ibd.delFlag != null and ibd.delFlag != ''">
				AND ibd.del_flag = #{ibd.delFlag}
			</if>
			<if test="ibd.md != null">
				LEFT JOIN 
					(
						SELECT 
							id,
							measname 
						FROM llm_measdoc
						WHERE 1 = 1
						<if test="ibd.md.delFlag != null and ibd.md.delFlag != ''">
							AND del_flag = #{ibd.md.delFlag}
						</if>
					) md 
				ON md.id = ibd.pk_measdoc
			</if>
		</if>
		<if test="imd != null">
			JOIN llm_invmandoc imd ON imd.pk_invbasdoc = aob.cbaseid
			<if test="imd.delFlag != null and imd.delFlag != ''">
				AND imd.del_flag = #{imd.delFlag}
			</if>
		</if>
		<if test="sd != null">
			JOIN llm_stordoc sd ON sd.id = aob.cwarehouseid
			<if test="sd.delFlag != null and sd.delFlag != ''">
				AND sd.del_flag = #{sd.delFlag}
			</if>
		</if>
	</sql>
	
	<!-- 插入到货单主表 -->
	<insert id="insert" parameterType="SupplyArriveOrder">
		INSERT INTO llm_arriveorder(
			id,
			varrordercode,
			dreceivedate,
			cbiztype,
			cvendormangid,
			cemployeeid,
			cdeptid,
			ctransmodeid,
			creceivepsn,
			cstoreorganization,
			bisback,
			vbackreasonh,
			vmemo,
			coperator,
			tmaketime,
			cauditpsn,
			taudittime,
			pk_corp,
			ibillstatus,
			receiveflag,
			inf_qc_date,
			pk_zjmanage,
			zjsign_state,
			zjdate,
			pk_rkmanage,
			rksign_state,
			rkdate,
			hclosed,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES (
			#{id},
			#{varrordercode},
			#{dreceivedate},
			#{cbiztype},
			#{cvendormangid},
			#{cemployeeid},
			#{cdeptid},
			#{ctransmodeid},
			#{creceivepsn},
			#{cstoreorganization},
			#{bisback},
			#{vbackreasonh},
			#{vmemo},
			#{coperator},
			#{tmaketime},
			#{cauditpsn},
			#{taudittime},
			#{pkCorp},
			#{ibillstatus},
			#{receiveflag},
			#{infQcDate},
			#{pkZjmanage},
			#{zjsignState},
			#{zjdate},
			#{pkRkmanage},
			#{rksignState},
			#{rkdate},
			#{hclosed},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag}
		)
	</insert>
	
	<!-- 插入到货单子表 -->
	<insert id="insertChild" parameterType="SupplyArriveOrderB">
		INSERT INTO llm_arriveorder_b(
			id,
			carriveorderid,
			cbaseid,
			cmangid,
			blargess,
			blargessuprow,
			narrvnum,
			nelignum,
			nnotelignum,
			cwarehouseid,
			vproducenum,
			csourcebillid,
			csourcebillrowid,
			cprojectid,
			crowno,
			naccumwarehousenum,
			nprice,
			nmoney,
			invstatus,
			overstocknum,
			overstockflag,
			now_ninnum,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES (
			#{id},
			#{carriveorderid},
			#{cbaseid},
			#{cmangid},
			#{blargess},
			#{blargessuprow},
			#{narrvnum},
			#{nelignum},
			#{nnotelignum},
			#{cwarehouseid},
			#{vproducenum},
			#{csourcebillid},
			#{csourcebillrowid},
			#{cprojectid},
			#{crowno},
			#{naccumwarehousenum},
			#{nprice},
			#{nmoney},
			#{invstatus},
			#{overstocknum},
			#{overstockflag},
			#{nowNinnum},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag}
		)
	</insert>

	<select id="findList" parameterType="SupplyArriveOrder" resultType="SupplyArriveOrder">
		SELECT 
			<include refid="arriveOrderColumns"/>
		FROM llm_arriveorder ao
		<include refid="arriveOrderJoins" />
		<where>
			1 = 1
			<if test="varrordercode != null and varrordercode != ''">
				AND ao.varrordercode LIKE '%'||#{varrordercode}||'%'
			</if>
			<if test="coperator != null and coperator != ''">
				AND ao.coperator = #{coperator}
			</if>
			<if test="creceivepsn != null and creceivepsn != ''">
				AND ao.creceivepsn = #{creceivepsn}
			</if>
			<if test="rksignState != null and rksignState != ''">
				AND ao.rksign_state = #{rksignState}
			</if>
<!-- 			<if test="hclosed != null and hclosed == 0"> -->
<!-- 				<![CDATA[AND EXISTS (SELECT 1 FROM llm_arriveorder_b aob WHERE (aob.nelignum - aob.naccumwarehousenum) > 0 AND aob.carriveorderid = ao.ID)]]> -->
<!-- 			</if> -->
<!-- 			<if test="hclosed != null and hclosed == 1"> -->
<!-- 				<![CDATA[AND NOT EXISTS (SELECT 1 FROM llm_arriveorder_b aob WHERE (aob.nelignum - aob.naccumwarehousenum) > 0 AND aob.carriveorderid = ao.ID)]]> -->
<!-- 			</if> -->
			<if test="hclosed != null and hclosed != ''">
				AND ao.hclosed = #{hclosed}
			</if>
			<if test="zjsignState != null and zjsignState != ''">
				AND ao.zjsign_state = #{zjsignState}
			</if>
			<if test="receiveflag != null and receiveflag != ''">
				AND ao.receiveflag = #{receiveflag}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND ao.del_flag = #{delFlag}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY ao.dreceivedate DESC
			</otherwise>
		</choose>
	</select>
    
	<select id="findChildList" parameterType="SupplyArriveOrderB" resultType="SupplyArriveOrderB">
		SELECT 
			<include refid="arriveOrderBColumns"/>
		FROM llm_arriveorder_b aob
		<include refid="arriveOrderBJoins" />
		<where>
			aob.carriveorderid = #{carriveorderid}
			<if test="delFlag != null and delFlag != ''">
				AND aob.del_flag = #{delFlag}
			</if>
		</where>

		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findInfo" parameterType="SupplyArriveOrder" resultType="SupplyArriveOrder">
		SELECT 
			<include refid="arriveOrderColumns"/>
		FROM llm_arriveorder ao
		<include refid="arriveOrderJoins" />
		<where>
			1 = 1
			<if test="id != null and id != ''">
				AND ao.id = #{id}
			</if>
			<if test="varrordercode != null and varrordercode != ''">
				AND ao.varrordercode = #{varrordercode}
			</if>
			<if test="coperator != null and coperator != ''">
				AND ao.coperator = #{coperator}
			</if>
			<if test="creceivepsn != null and creceivepsn != ''">
				AND ao.creceivepsn = #{creceivepsn}
			</if>
			<if test="rksignState != null and rksignState != ''">
				AND ao.rksign_state = #{rksignState}
			</if>
			<if test="zjsignState != null and zjsignState != ''">
				AND ao.zjsign_state = #{zjsignState}
			</if>
			<if test="receiveflag != null and receiveflag != ''">
				AND ao.receiveflag = #{receiveflag}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND ao.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<update id="update" parameterType="SupplyArriveOrder">
		UPDATE llm_arriveorder SET 	
			
			<if test="receiveflag != null and receiveflag != ''">receiveflag = #{receiveflag},</if>
			<if test="infQcDate != null">inf_qc_date = #{infQcDate},</if>
			<if test="pkZjmanage != null and pkZjmanage != ''">pk_zjmanage = #{pkZjmanage},</if>
			<if test="zjsignState != null and zjsignState != ''">zjsign_state = #{zjsignState},</if>
			<if test="zjdate != null">zjdate = #{zjdate},</if>
<!-- 			<if test="pkRkmanage != null and pkRkmanage != ''">pk_rkmanage = #{pkRkmanage},</if> -->
			<if test="rksignState != null and rksignState != ''">rksign_state = #{rksignState},</if>
			<if test="rkdate != null">rkdate = #{rkdate},</if>
			<if test="hclosed != null and hclosed != ''">hclosed = #{hclosed},</if>
			
			update_by = #{updateBy.id},
			update_date = #{updateDate}
			
		WHERE id = #{id}
	</update>
	
	<update id="updateChild" parameterType="SupplyArriveOrderB">
		UPDATE llm_arriveorder_b SET 	
			
			<if test="nelignum != null">nelignum = #{nelignum},</if>
			<if test="nnotelignum != null">nnotelignum = #{nnotelignum},</if>
			<if test="naccumwarehousenum != null">naccumwarehousenum = #{naccumwarehousenum},</if>
			<if test="nowNinnum != null">now_ninnum = #{nowNinnum},</if>

			update_by = #{updateBy.id},
			update_date = #{updateDate}

		WHERE id = #{id}
	</update>
	
	<update id="delete" parameterType="SupplyArriveOrder">
		UPDATE llm_arriveorder SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	
	<update id="deleteChild" parameterType="SupplyArriveOrderB">
		UPDATE llm_arriveorder_b SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	
</mapper>