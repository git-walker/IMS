<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.rootyu.rad.modules.supply.dao.BuyOrderDao">

	<sql id="buyOrderColumns">
		bo.id,
		bo.vordercode,
		bo.nversion,
		bo.pk_corp,
		bo.cbiztype,
		bo.bisreplenish,
		bo.dorderdate,
		bo.cpurorganization,
		bo.cvendormangid,
		bo.cfreecustid,
		bo.cemployeeid,
		bo.cdeptid,
		bo.breturn,
		bo.vmemo,
		bo.pk_corp1,
		bo.coperator,
		bo.tmaketime,
		bo.cauditpsn,
		bo.taudittime,
		bo.forderstatus,
		bo.ctransmodeid
		<if test="cmd != null and cbd != null">
			,
			cbd.custcode AS "cbd.custcode",
			cbd.custname AS "cbd.custname",
			cbd.custshortname AS "cbd.custshortname"
		</if>
		<if test="cgemp != null">
			,
			cgemp.name AS "cgemp.name"
		</if>
		<if test="zdemp != null">
			,
			zdemp.name AS "zdemp.name"
		</if>
	</sql>
	
	<sql id="buyOrderJoins">
		<if test="cmd != null and cbd != null">
			LEFT JOIN 
				(
					SELECT
						cmdt.id,
						cbdt.custcode,
						cbdt.custname,
						cbdt.custshortname
					FROM llm_cumandoc cmdt
					JOIN llm_cubasdoc cbdt ON cbdt.id = cmdt.pk_cubasdoc
					<if test="cbd.delFlag != null and cbd.delFlag != ''">
						AND cbdt.del_flag = #{cbd.delFlag}
					</if>
					WHERE 1 = 1
					<if test="cmd.delFlag != null and cmd.delFlag != ''">
						AND cmdt.del_flag = #{cmd.delFlag}
					</if>
				) cbd 
			ON cbd.id = bo.cvendormangid
		</if>
		<if test="cgemp != null">
			LEFT JOIN 
				(
					SELECT 
						id,
						name 
					FROM sys_user
					WHERE 1 = 1
					<if test="cgemp.delFlag != null and cgemp.delFlag != ''">
						AND del_flag = #{cgemp.delFlag}
					</if>
				) cgemp 
			ON cgemp.id = bo.cemployeeid
		</if>
		<if test="zdemp != null">
			LEFT JOIN 
				(
					SELECT 
						id,
						name 
					FROM sys_user
					WHERE 1 = 1
					<if test="zdemp.delFlag != null and zdemp.delFlag != ''">
						AND del_flag = #{zdemp.delFlag}
					</if>
				) zdemp 
			ON zdemp.id = bo.coperator
		</if>
	</sql>
	
	<sql id="buyOrderBColumns">
		bob.id,
		bob.corderid,
		bob.pk_arrvstoorg,
		bob.crowno,
		bob.ccontractid,
		bob.cbaseid,
		bob.blargess,
		bob.vproducenum,
		bob.nordernum,
		bob.norgtaxprice,
		bob.noriginalcurprice,
		bob.ntaxrate,
		bob.noriginalcurmny,
		bob.norigtaxcurmny,
		bob.noriginalnetprice,
		bob.cprojectid,
		bob.pk_corp,
		bob.naccumstorenum,
		bob.cwarehouseid,
		bob.naccumarrvnum,
		bob.iisactive
		<if test="ibd != null">
			,
			ibd.id AS "ibd.id",
			ibd.invcode AS "ibd.invcode",
			ibd.invname AS "ibd.invname",
			ibd.invspec AS "ibd.invspec",
			ibd.invtype AS "ibd.invtype",
			ibd.pk_measdoc AS "ibd.pkMeasdoc"
			<if test="ibd.md != null">
				,
				md.id AS "ibd.md.id",
				md.measname AS "ibd.md.measname"
			</if>
		</if>
		<if test="imd != null">
			,
			imd.id AS "imd.id",
			imd.pk_invbasdoc AS "imd.pkInvbasdoc",
			imd.serialmanaflag AS "imd.serialmanaflag",
			imd.wholemanaflag AS "imd.wholemanaflag",
			imd.instancyflag AS "imd.instancyflag"
		</if>
		<if test="sd != null">
			,
			sd.id AS "sd.id",
			sd.storcode AS "sd.storcode",
			sd.storname AS "sd.storname",
			sd.pk_reservoirid AS "sd.pkReservoirid"
		</if>
	</sql>
	
	<sql id="buyOrderBJoins">
		<if test="ibd != null">
			LEFT JOIN (
				SELECT
					id,
					invcode,
					invname,
					invspec,
					invtype,
					pk_measdoc
				FROM llm_invbasdoc
				WHERE 1 = 1
				<if test="ibd.delFlag != null and ibd.delFlag != ''">
					AND del_flag = #{ibd.delFlag}
				</if>
			) ibd ON ibd.id = bob.cbaseid
			<if test="ibd.md != null">
				LEFT JOIN 
					(
						SELECT 
							id,
							measname 
						FROM llm_measdoc
						WHERE 1 = 1
						<if test="ibd.md.delFlag != null and ibd.md.delFlag != ''">
							AND del_flag = #{ibd.md.delFlag}
						</if>
					) md 
				ON md.id = ibd.pk_measdoc
			</if>
		</if>
		<if test="imd != null">
			LEFT JOIN (
				SELECT
					id,
					pk_invbasdoc,
					serialmanaflag,
					wholemanaflag,
					instancyflag
				FROM llm_invmandoc
				WHERE 1 = 1
				<if test="imd.delFlag != null and imd.delFlag != ''">
					AND del_flag = #{imd.delFlag}
				</if>
			) imd ON imd.pk_invbasdoc = bob.cbaseid
		</if>
		<if test="sd != null">
			JOIN (
				SELECT
					id,
					storcode,
					storname,
					pk_reservoirid
				FROM llm_stordoc
				WHERE 1 = 1
				<if test="sd.delFlag != null and sd.delFlag != ''">
					AND del_flag = #{sd.delFlag}
				</if>
				<!--TODO 限制仓三、仓四，排除新区紧固件库 -->
				AND pk_reservoirid IN ('7b4adf6547bb4cd89aba7721b5253fc4','97d66e3a31dc4f9da806b424bd798c53')
				AND id NOT IN ('1006A3100000000GZ2VB')
			) sd ON sd.id = bob.cwarehouseid
		</if>
	</sql>

	<!-- version 2015-10-22 -->
	<select id="findInfo" parameterType="SupplyBuyOrder" resultType="SupplyBuyOrder">
		SELECT 
			<include refid="buyOrderColumns"/>	
		FROM llm_order bo
		<include refid="buyOrderJoins" />
		<where>
			1 = 1
			<if test="id != null and id != ''">
				AND bo.id = #{id}
			</if>
			<if test="vordercode != null and vordercode != ''">
				AND bo.vordercode = #{vordercode}
			</if>
			<if test="cemployeeid != null and cemployeeid != ''">
				AND bo.cemployeeid = #{cemployeeid}
			</if>
			<if test="forderstatus != null and forderstatus != ''">
				AND bo.forderstatus = #{forderstatus}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND bo.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<!-- version 2015-10-22 -->
	<select id="findList" parameterType="SupplyBuyOrder" resultType="SupplyBuyOrder">
		SELECT 
			<include refid="buyOrderColumns"/>
		FROM llm_order bo
		<include refid="buyOrderJoins" />
		<where>
			1 = 1
			<!--TODO 限制仓三、仓四订单，排除新区紧固件库 -->
			AND EXISTS (SELECT 1 FROM (
				SELECT 
					DISTINCT bobt.corderid
				FROM llm_order_b bobt
				JOIN llm_stordoc sdt ON sdt.id = bobt.cwarehouseid AND sdt.del_flag = '0'
					AND sdt.pk_reservoirid IN ('7b4adf6547bb4cd89aba7721b5253fc4','97d66e3a31dc4f9da806b424bd798c53')
					AND sdt.id NOT IN ('1006A3100000000GZ2VB')
				WHERE bobt.del_flag = '0'
			) bob WHERE bob.corderid = bo.ID)
			<if test="cmd != null and cbd != null">
				<if test="cbd.custname != null and cbd.custname != ''">
					AND cbd.custname LIKE '%'||#{cbd.custname}||'%'
				</if>
			</if>
			<if test="iisactive != null and iisactive == 1">
				<![CDATA[AND NOT EXISTS (SELECT 1 FROM llm_order_b bob WHERE (bob.nordernum - bob.naccumarrvnum) > 0 AND bob.iisactive='0' AND bob.corderid = bo.ID)]]>
			</if>
			<if test="iisactive != null and iisactive == 0">
				<![CDATA[AND EXISTS (SELECT 1 FROM llm_order_b bob WHERE (bob.nordernum - bob.naccumarrvnum) > 0 AND bob.iisactive='0' AND bob.corderid = bo.ID)]]>
			</if>
			<if test="vordercode != null and vordercode != ''">
				AND bo.vordercode LIKE '%'||#{vordercode}||'%'
			</if>
			<if test="cemployeeid != null and cemployeeid != ''">
				AND bo.cemployeeid = #{cemployeeid}
			</if>
			<if test="forderstatus != null and forderstatus != ''">
				AND bo.forderstatus = #{forderstatus}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND bo.del_flag = #{delFlag}
			</if>
			${sqlMap.fwhere}
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY bo.dorderdate DESC
			</otherwise>
		</choose>
	</select>
	
	<!-- version 2015-10-21 -->
	<select id="findChildList" parameterType="SupplyBuyOrderB" resultType="SupplyBuyOrderB">
		SELECT 
			<include refid="buyOrderBColumns"/>
		FROM llm_order_b bob
		<include refid="buyOrderBJoins" />
		<where>
			bob.corderid = #{corderid}
			<if test="iisactive != null and iisactive != ''">
				AND bob.iisactive = #{iisactive}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND bob.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<!-- 更新之前未做查询操作，此字段不能变 -->
	<update id="update" parameterType="SupplyBuyOrder">
		UPDATE llm_order SET 
			forderstatus = #{forderstatus},
			update_by = #{updateBy.id},
			update_date = #{updateDate}
		WHERE id = #{id}
	</update>
	
	<!-- 更新之前未做查询操作，此字段不能变 -->
	<update id="updateChild" parameterType="SupplyBuyOrderB">
		UPDATE llm_order_b SET 

			<if test="iisactive != null and iisactive != ''">iisactive = #{iisactive},</if>
			<if test="naccumarrvnum != null">naccumarrvnum = #{naccumarrvnum},</if>
			<if test="naccumstorenum != null">naccumstorenum = #{naccumstorenum},</if>
			
			update_by = #{updateBy.id},
			update_date = #{updateDate}
		WHERE id = #{id}
	</update>
	
</mapper>