<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.rootyu.rad.modules.supply.dao.SupplyDataDao">
	
	<select id="findInvRelationList" parameterType="SupplyInvRelation" resultType="SupplyInvRelation">
		SELECT 
			swiv.gzzxbmid AS "smf.pkWkcenter",
			smf.pk_cwarehouseid AS "smf.pkCwarehouseid",
			smf.pk_storekeeper AS "smf.pkStorekeeper"
		<if test="ohn != null">
			,
			ohn.id AS "ohn.id",
			ohn.pk_invbasdoc AS "ohn.pkInvbasdoc",
			ohn.safetystocknum AS "ohn.safetystocknum",
			ohn.lowstocknum AS "ohn.lowstocknum",
			ohn.maxstornum AS "ohn.maxstornum",
			ohn.pk_stordoc AS "ohn.pkStordoc",
			ohn.currentamount AS "ohn.currentamount",
			ohn.pk_stationid AS "ohn.pkStationid",
			ohn.pk_goodid AS "ohn.pkGoodid"
		</if>
		FROM (
			SELECT
				distinct rtb.gzzxbmid
			FROM llm_rt_b rtb
			<where>
				EXISTS (
					SELECT 1
            		FROM llm_opac oc
            		WHERE rtb.id = oc.pk_rt_bid AND oc.wlbmid = #{pkInvbasdoc} AND oc.del_flag = #{smf.delFlag}
				)
				AND EXISTS (
             		SELECT 1 FROM llm_rt rt WHERE rt.ID = rtb.pk_rtid AND rt.sfmr = 'Y'
             	)
			</where>
		) swiv
		LEFT JOIN (
			SELECT
				pk_cwarehouseid,
				pk_wkcenter,
				pk_storekeeper
			FROM llm_wkstadoc
			<where>
				pk_cwarehouseid = #{smf.pkCwarehouseid}
				<if test="smf.delFlag != null and smf.delFlag != ''">
					AND del_flag = #{smf.delFlag}
				</if>
			</where>
		) smf ON smf.pk_wkcenter = swiv.gzzxbmid
		<if test="ohn != null">
			LEFT JOIN (
				SELECT
					id,
					pk_invbasdoc,
					safetystocknum,
					lowstocknum,
					maxstornum,
					pk_stordoc,
					currentamount,
					pk_stationid,
					pk_goodid
				FROM llm_onhandnum
				<where>
					pk_invbasdoc = #{pkInvbasdoc}
					AND pk_stordoc = #{smf.pkCwarehouseid}
					<if test="ohn.delFlag != null and ohn.delFlag != ''">
						AND del_flag = #{ohn.delFlag}
					</if>
				</where>
			) ohn 
			ON ohn.pk_stationid = swiv.gzzxbmid
		</if>
	</select>
	
	<select id="findInvRelationNoRtList" parameterType="SupplyInvRelation" resultType="SupplyInvRelation">
		SELECT 
			smf.pk_wkcenter AS "smf.pkWkcenter",
			smf.pk_cwarehouseid AS "smf.pkCwarehouseid",
			smf.pk_storekeeper AS "smf.pkStorekeeper"
		<if test="ohn != null">
			,
			ohn.id AS "ohn.id",
			ohn.pk_invbasdoc AS "ohn.pkInvbasdoc",
			ohn.safetystocknum AS "ohn.safetystocknum",
			ohn.lowstocknum AS "ohn.lowstocknum",
			ohn.maxstornum AS "ohn.maxstornum",
			ohn.pk_stordoc AS "ohn.pkStordoc",
			ohn.currentamount AS "ohn.currentamount",
			ohn.pk_stationid AS "ohn.pkStationid",
			ohn.pk_goodid AS "ohn.pkGoodid"
		</if>
		FROM (
			SELECT
				pk_cwarehouseid,
				pk_wkcenter,
				pk_storekeeper
			FROM llm_wkstadoc
			<where>
				pk_cwarehouseid = #{smf.pkCwarehouseid}
				<if test="smf.delFlag != null and smf.delFlag != ''">
					AND del_flag = #{smf.delFlag}
				</if>
			</where>
		) smf 
		<if test="ohn != null">
			LEFT JOIN (
				SELECT
					id,
					pk_invbasdoc,
					safetystocknum,
					lowstocknum,
					maxstornum,
					pk_stordoc,
					currentamount,
					pk_stationid,
					pk_goodid
				FROM llm_onhandnum
				<where>
					pk_invbasdoc = #{pkInvbasdoc}
					AND pk_stordoc = #{smf.pkCwarehouseid}
					<if test="ohn.delFlag != null and ohn.delFlag != ''">
						AND del_flag = #{ohn.delFlag}
					</if>
				</where>
			) ohn 
			ON ohn.pk_stationid = smf.pk_wkcenter
		</if>
	</select>
	
	<select id="findOnhandNumList" parameterType="SupplyOnhandNum" resultType="SupplyOnhandNum">
		SELECT 
			ohn.id,
			ohn.pk_invbasdoc,
			ohn.safetystocknum,
			ohn.lowstocknum,
			ohn.maxstornum,
			ohn.pk_stordoc,
			ohn.currentamount,
			ohn.pk_stationid,
			ohn.pk_goodid
		FROM llm_onhandnum ohn
		<where>
			1 = 1
			<if test="pkInvbasdocList != null">
				AND ohn.pk_invbasdoc IN
				<foreach collection="pkInvbasdocList" index="index" item="item" open=" (" separator="," close=") ">
					#{item}
				</foreach>
			</if>
			<if test="pkStordoc != null and pkStordoc != ''">
				AND ohn.pk_stordoc = #{pkStordoc}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND ohn.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<sql id="stationColumns">
		sta.id AS "id",
		sta.gzzxbm AS "gzzxbm",
		sta.gzzxmc AS "gzzxmc"
	</sql>
	
	<select id="findStationInfo" parameterType="SupplyStation" resultType="SupplyStation">
		SELECT 
			<include refid="stationColumns"/>
		FROM llm_wk sta
		<where>
			sta.id = #{id}
			<if test="delFlag != null and delFlag != ''">
				AND sta.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<select id="findStationList" parameterType="SupplyStation" resultType="SupplyStation">
		SELECT 
			<include refid="stationColumns"/>
		FROM llm_wk sta
		<where>
			1 = 1
			<if test="idList != null">
				AND sta.id IN
				<foreach collection="idList" index="index" item="item" open=" (" separator="," close=") ">
					#{item}
				</foreach>
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND sta.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<sql id="cargDocColumns">
		cd.id,
		cd.code
	</sql>
	
	<select id="findCargDocInfo" parameterType="SupplyCargDoc" resultType="SupplyCargDoc">
		SELECT 
			<include refid="cargDocColumns"/>
		FROM llm_cargdoc cd
		<where>
			cd.id = #{id}
			<if test="delFlag != null and delFlag != ''">
				AND cd.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<select id="findCargDocList" parameterType="SupplyCargDoc" resultType="SupplyCargDoc">
		SELECT 
			<include refid="cargDocColumns"/>
		FROM llm_cargdoc cd
		<where>
			1 = 1
			<if test="idList != null">
				AND cd.id IN
				<foreach collection="idList" index="index" item="item" open=" (" separator="," close=") ">
					#{item}
				</foreach>
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND cd.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<sql id="storDocColumns">
		sd.id,
		sd.storcode,
		sd.storname,
		sd.pk_reservoirid
	</sql>
	
	<select id="findStorDocInfo" parameterType="SupplyStorDoc" resultType="SupplyStorDoc">
		SELECT 
			<include refid="storDocColumns"/>
		FROM llm_stordoc sd
		<where>
			1 = 1
			<if test="id != null and id != ''">
				AND sd.id = #{id}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND sd.del_flag = #{delFlag}
			</if>
		</where>
	</select>

	<select id="findStorDocList" parameterType="SupplyStorDoc" resultType="SupplyStorDoc">
		SELECT 
			<include refid="storDocColumns"/>
		FROM llm_stordoc sd
		<where>
			1 = 1
			<if test="idList != null">
				AND sd.id IN
				<foreach collection="idList" index="index" item="item" open=" (" separator="," close=") ">
					#{item}
				</foreach>
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND sd.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<select id="findUserInfo" parameterType="User" resultType="User">
		SELECT 
			u.id,
			u.name,
			u.login_name,
			u.office_id AS "office.id"
		<if test="office != null">
			,
			office.name AS "office.name"
		</if>
		FROM sys_user u
		<if test="role != null">
			JOIN sys_user_role ur ON ur.user_id = u.id
  			JOIN sys_role r ON r.id = ur.role_id
  			<if test="role.enname != null and role.enname != ''">
				AND r.enname = #{role.enname}
			</if>
			<if test="role.delFlag != null and role.delFlag != ''">
				AND r.del_flag = #{role.delFlag}
			</if>
		</if>
		<if test="office != null">
			JOIN sys_office office ON office.id = u.office_id
			<if test="office.id != null and office.id != ''">
				AND u.office_id = #{office.id}
			</if>
			<if test="office.delFlag != null and office.delFlag != ''">
				AND office.del_flag = #{office.delFlag}
			</if>
		</if>
		<where>
			1 = 1
			<if test="delFlag != null and delFlag != ''">
				AND u.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<select id="findUserList" parameterType="User" resultType="User">
		SELECT 
			u.id,
			u.name,
			u.login_name,
			u.office_id AS "office.id"
		<if test="office != null">
			,
			office.name AS "office.name"
		</if>
		FROM sys_user u
		<if test="role != null">
			JOIN sys_user_role ur ON ur.user_id = u.id
  			JOIN sys_role r ON r.id = ur.role_id
  			<if test="role.enname != null and role.enname != ''">
				AND r.enname = #{role.enname}
			</if>
			<if test="role.delFlag != null and role.delFlag != ''">
				AND r.del_flag = #{role.delFlag}
			</if>
		</if>
		<if test="office != null">
			JOIN sys_office office ON office.id = u.office_id
			<if test="office.id != null and office.id != ''">
				AND u.office_id = #{office.id}
			</if>
			<if test="office.code != null and office.code != ''">
				AND office.code = #{office.code}
			</if>
			<if test="office.delFlag != null and office.delFlag != ''">
				AND office.del_flag = #{office.delFlag}
			</if>
		</if>
		<where>
			1 = 1
			<if test="delFlag != null and delFlag != ''">
				AND u.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<sql id="invBasDocColumns">
		ibd.id,
		ibd.invcode,
		ibd.invname,
		ibd.invspec,
		ibd.invtype,
		ibd.pk_measdoc
	</sql>
	
	<select id="findInvBasDocInfo" parameterType="SupplyInvBasDoc" resultType="SupplyInvBasDoc">
		SELECT 
			<include refid="invBasDocColumns"/>
		FROM llm_invbasdoc ibd
		<where>
			ibd.id = #{id}
			<if test="delFlag != null and delFlag != ''">
				AND ibd.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
	<sql id="jobBasFilColumns">
		jbf.id,
		jbf.jobcode,
		jbf.jobname
	</sql>
	
	<sql id="jobBasFilJoins">
		<if test="jmf != null">
			JOIN llm_jobmngfil jmf ON jmf.pk_jobbasfil = jbf.id
			<if test="jmf.delFlag != null and jmf.delFlag != ''">
				AND jmf.del_flag = #{jmf.delFlag}
			</if>
		</if>
	</sql>
	
	<select id="findJobBasFilInfo" parameterType="SupplyJobBasFil" resultType="SupplyJobBasFil">
		SELECT 
			<include refid="jobBasFilColumns"/>
		FROM llm_jobbasfil jbf
		<include refid="jobBasFilJoins" />
		<where>
			1 = 1
			<if test="jmf != null">
				<if test="jmf.id != null and jmf.id != ''">
					AND jmf.id = #{jmf.id}
				</if>
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND jbf.del_flag = #{delFlag}
			</if>
		</where>
	</select>
	
</mapper>