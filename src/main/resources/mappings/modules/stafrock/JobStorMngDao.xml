<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.rootyu.rad.modules.stafrock.dao.JobStorMngDao">
    
	<sql id="jobStorMngColumns">
		a.principalphone AS "principalphone",
		a.gubflag AS "gubflag",
		a.isatpaffected AS "isatpaffected",
		a.iscalculatedinvcost AS "iscalculatedinvcost",
		a.memo AS "memo",
		a.pk_address AS "pkAddress",
		a.pk_calbody AS "pkCalbody",
		a.pk_corp AS "pkCorp",
		a.principalname AS "principalname",
		a.proflag AS "proflag",
		a.sealflag AS "sealflag",
		a.storaddr AS "storaddr",
		a.storcode AS "storcode",
		a.storname AS "storname",
		a.supbalflag AS "supbalflag",
		a.storageflag AS "storageflag",
		a.addresscode AS "addresscode",
		a.id AS "id",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.remarks AS "remarks",
		a.del_flag AS "delFlag",
		a.pk_reservoirid AS "pkReservoirid",
		a.vehiclemodelid AS "vehiclemodelid",
		o.id AS "office.id",
		o.name AS "office.name",
		(select t.label from sys_dict t where t.type = 'vehicle_model' and t.value =  a.vehiclemodelid) vehiclemodel
	</sql>
	
	<sql id="jobStorMngJoins">
		LEFT JOIN sys_office o ON o.id = a.pk_reservoirid
	</sql>
    
	<select id="get" resultType="JobStorMng">
		SELECT 
			<include refid="jobStorMngColumns"/>
		FROM llm_stordoc a
		<include refid="jobStorMngJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="JobStorMng">
		SELECT 
			<include refid="jobStorMngColumns"/>
		FROM llm_stordoc a
		<include refid="jobStorMngJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL} and a.pk_corp=#{ERP_CORP_ID}  AND a.sealflag=#{sealflag}

		<if test="storcode !=null and storcode !=''">
			AND a.storcode LIKE
					<if test="dbName == 'oracle'">'%'||#{storcode}||'%'</if>
		</if>
		<if test="storname !=null and storname !=''">
			AND a.storname LIKE
					<if test="dbName == 'oracle'">'%'||#{storname}||'%'</if>
		</if>
		<if test="pkReservoirid !=null and pkReservoirid !=''">
			AND a.pk_reservoirid = #{pkReservoirid}
		</if>
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date ASC
			</otherwise>
		</choose>		
	</select>
	
	<select id="getStoreRoomList" resultType="Office" >
		SELECT 
		a.name AS  "name",
		a.id AS "id"
		FROM sys_office a
		where a.parent_id=#{WULIU_OFFICE_ID} and a.del_flag = #{DEL_FLAG_NORMAL}
		ORDER BY a.code ASC
	</select>
	<select id="getVehiclemodelidList" resultType="java.util.HashMap" >
		select 
		t.value as "id",
		t.label as "name" 
		from sys_dict t 
		where t.type = 'vehicle_model'
	</select>	
	<!--<select id="jobsMtorMatch" resultType="JobStorMng">
		SELECT 
			<include refid="jobStorMngColumns"/>
		FROM llm_stordoc a
			<include refid="jobStorMngJoins"/>
		WHERE a.id = #{storid}
	</select>
	--><insert id="insert">
		INSERT INTO llm_stordoc(
			principalphone,
			gubflag,
			isatpaffected,
			iscalculatedinvcost,
			memo,
			pk_address,
			pk_calbody,
			pk_corp,
			principalname,
			proflag,
			sealflag,
			storaddr,
			storcode,
			storname,
			supbalflag,
			storageflag,
			addresscode,
			id,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag,
			pk_reservoirid
		) VALUES (
			#{principalphone},
			#{gubflag},
			#{isatpaffected},
			#{iscalculatedinvcost},
			#{memo},
			#{pkAddress},
			#{pkCalbody},
			#{pkCorp},
			#{principalname},
			#{proflag},
			#{sealflag},
			#{storaddr},
			#{storcode},
			#{storname},
			#{supbalflag},
			#{storageflag},
			#{addresscode},
			#{id},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag},
			#{pkReservoirid}
		)
	</insert>
	
	<update id="update">
		UPDATE llm_stordoc SET 	
			principalphone=#{principalphone},
			gubflag=#{gubflag},
			isatpaffected=#{isatpaffected},
			iscalculatedinvcost=#{iscalculatedinvcost},
			memo=#{memo},
			pk_address=#{pkAddress},
			pk_calbody=#{pkCalbody},
			pk_corp=#{pkCorp},
			principalname=#{principalname},
			proflag=#{proflag},
			sealflag=#{sealflag},
			storaddr=#{storaddr},
			storcode=#{storcode},
			storname=#{storname},
			supbalflag=#{supbalflag},
			storageflag=#{storageflag},
			addresscode=#{addresscode},
			id=#{id},
			create_by=#{createBy.id},
			create_date=#{createDate},
			update_by=#{updateBy.id},
			update_date=#{updateDate},
			remarks=#{remarks},
			del_flag=#{delFlag},
			pk_reservoirid=#{pkReservoirid}			
		WHERE id = #{id}
	</update>
	
	<update id="updateStoreroom">
		UPDATE llm_stordoc SET 
			PK_RESERVOIRID = #{pkReservoirid}
		WHERE id = #{id}
	</update>
	<update id="updateVehiclemodelid">
		UPDATE llm_stordoc SET 
			vehiclemodelid = #{vehiclemodelid}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE llm_stordoc  SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	
	<select id="getAllStorDocTree" parameterType="java.util.HashMap" resultType="cn.rootyu.rad.modules.stafrock.entity.CargDoc">
		select *
		  from (select a.id,
		               a.parent_id AS "parent.id",
		               a.parent_id parentId,
		               a.name,
		               a.code,
		               a.grade,
		               p.name AS "parent.name"
		          from llm_cargdoc a
		          LEFT JOIN llm_cargdoc p ON p.id = a.parent_id
		         where a.del_flag = '0'
		           and a.grade in ('1', '2')
		           and a.reservoir_id = #{reservoirId}
		          <!-- and a.id not in
		               (select pk_cargcol
		                  from llm_stor_carg
		                 where del_flag = '0')
		        union all
		        select a.id,
		               a.parent_id AS "parent.id",
		               a.parent_id parentId,
		               a.name,
		               a.code,
		               a.grade,
		               p.name AS "parent.name"
		          from llm_cargdoc a
		          LEFT JOIN llm_cargdoc p ON p.id = a.parent_id
		         where a.del_flag = '0'
		           and a.id in (select a.PK_CARGCOL
		                          from LLM_STOR_CARG a
		                         where PK_STORDOC = #{storDocId}
		                           and del_flag = '0')-->)
		 order by code

	</select>
	
	<select id="getStorDocIdList" parameterType="cn.rootyu.rad.modules.stafrock.entity.StorCarg" resultType="String">
		select a.PK_CARGCOL as "id" from LLM_STOR_CARG a where PK_STORDOC = #{pkStordoc} and del_flag = #{DEL_FLAG_NORMAL}

	</select>
	<insert id="saveStorDocMenu" parameterType="cn.rootyu.rad.modules.stafrock.entity.StorCarg">
		INSERT INTO LLM_STOR_CARG(
			id,
			PK_STORDOC,
			PK_CARGCOL,			
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES (
			#{id},
			#{pkStordoc},
			#{pkCargcol},			
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag}
		)
	</insert>
	<update id="deleteStorDocMenu" parameterType="cn.rootyu.rad.modules.stafrock.entity.StorCarg">
		update  LLM_STOR_CARG set del_flag= #{DEL_FLAG_DELETE} where PK_STORDOC = #{pkStordoc} 
	</update>	
</mapper>