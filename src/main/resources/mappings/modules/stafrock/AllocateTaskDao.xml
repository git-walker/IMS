<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.rootyu.rad.modules.stafrock.dao.AllocateTaskDao">
<sql id="AllocateTaskColumns">
a.id AS "id",
a.batchsequence AS "batchSequence",
a.batchcode AS "batchCode",
a.alloc_num AS "allocNum",
a.alloc_stationid AS "allocStationid",
a.alloced_stationid AS "allocedStationid",
a.alloc_goodid AS "allocGoodid",
a.alloced_goodid AS "allocedGoodid",
a.alloc_storid AS "allocStorid",
a.alloced_storid AS "allocedStorid",
a.plan_time AS "planTime",
a.actual_time AS "actualTime",
a.actual_num AS "actualNum",
a.pk_invbasdoc AS "pkInvbasdoc",
a.allocuserid AS "allocUserid",
a.alloc_billcode AS "allocBillcode",
a.status_flag AS "statusFlag",
a.pk_rdcl AS "pkRdcl",
a.pk_rdcled AS "pkRdcled",
ibd.id AS "invbasdoc.id",
ibd.invname AS "invbasdoc.invname",
ibd.invcode AS "invbasdoc.invcode",
sd.id AS "stordoc.id",
sd.storname AS "stordoc.storname",
(select storname from llm_stordoc sd where sd.id=a.alloced_storid) AS "stordoc.stornamed",
cd.id AS "cargdoc.id",
cd.name AS "cargdoc.name",
(select name from llm_cargdoc cd where cd.id=a.alloced_goodid) AS "cargdoc.named",
wk.gzzxmc AS "wk.gzzxmc",
(select gzzxmc from llm_wk wk where wk.id=a.alloced_stationid) AS "wk.gzzxmced",
u.name AS "user.name",
o.id AS "office.id",
o.name AS "office.name"
</sql>
<sql id="AllocateTaskJoins">
	 left join llm_invbasdoc ibd on ibd.id = a.pk_invbasdoc
	 left join llm_stordoc sd on sd.id = a.alloc_storid
	 left join llm_cargdoc cd on cd.id = a.alloc_goodid
	 left join llm_wkstadoc ws on ws.id = a.alloc_stationid
   	 left join llm_wk wk on wk.id = ws.pk_wkcenter
   	 left join sys_user u ON u.id=a.allocuserid 
   	 left join sys_office o on  o.id=sd.PK_RESERVOIRID
	 
</sql>
<select id="get" resultType="AllocateTask">
		SELECT 
			<include refid="AllocateTaskColumns"/>
		FROM llm_allocate a
		<include refid="AllocateTaskJoins"/>
		WHERE a.id = #{id}
	</select>
	    <select id="findPage" resultType="AllocateTask">
		SELECT 
		<include refid="AllocateTaskColumns"/>
		FROM llm_allocate a
		<include refid="AllocateTaskJoins"/>
		WHERE a.id = #{id}
	</select>
	<select id="findList" resultType="AllocateTask">
		SELECT 
			<include refid="AllocateTaskColumns"/>
		FROM llm_allocate a
		<include refid="AllocateTaskJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="pkInvbasdoc != null and pkInvbasdoc != ''">
				AND a.pk_invbasdoc = #{pkInvbasdoc}
			</if>

		</where>
	</select>
	<select id="checkValues" resultType="AllocateTask" parameterType="String">
		SELECT 
			<include refid="AllocateTaskColumns"/>
		FROM llm_allocate a
		<include refid="AllocateTaskJoins"/>
		<where>
			a.id = #{id}
		</where>
	</select>
	<insert id="insert">
		INSERT INTO llm_allocate(
			id,
			batchsequence,
			batchcode,
			alloc_num,
			alloc_stationid,
			alloced_stationid,
			alloc_goodid,
			alloced_goodid,
			alloc_storid,
			alloced_storid,
			plan_time,
			actual_time,
			actual_num,
			pk_invbasdoc,
			allocuserid,
			alloc_billcode,
			status_flag,
			pk_rdcl,
			pk_rdcled
		) VALUES (
			#{id},
			#{batchSequence},
			#{batchCode},
			#{allocNum},
			#{allocStationid},
			#{allocedStationid},
			#{allocGoodid},
			#{allocedGoodid},
			#{allocStorid},
			#{allocedStorid},
			#{planTime},
			#{actualTime},
			#{actualNum},
			#{pkInvbasdoc},
			#{allocUserid},
			#{allocBillcode},
			#{statusFlag},
			#{pkRdcl},
			#{pkRdcled}
		)
	</insert>
	<update id="update">
		UPDATE llm_allocate SET 
			batchsequence = #{batchSequence},
			batchcode = #{batchCode},
			alloc_num = #{allocNum},
			alloc_stationid = #{allocStationid},
			alloced_stationid = #{allocedStationid},
			alloc_goodid = #{allocGoodid},
			alloced_goodid = #{allocedGoodid},
			alloc_storid = #{allocStorid},
			alloced_storid = #{allocedStorid},
			plan_time = #{planTime},
			actual_time = #{actualTime},
			actual_num = #{actualNum},
			pk_invbasdoc = #{pkInvbasdoc},
			allocuserid = #{allocUserid},
			alloc_billcode = #{allocBillcode},
			status_flag = #{statusFlag},
			pk_rdcl = #{pkRdcl},
			pk_rdcled = #{pkRdcled}
		WHERE id = #{id}
		  and del_flag = #{DEL_FLAG_NORMAL}
	</update>
	<update id="delete">
		UPDATE llm_allocate SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	<select id="getInvBasDocList" resultType="InvBasDoc">
		select ibd.id,ibd.invname,ibd.invcode
		from llm_invbasdoc ibd
		where ibd.pk_corp =#{ERP_CORP_ID} and ibd.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY ibd.invcode ASC 
	</select>
	<select id="findStordocList" resultType="Stordoc">
		SELECT distinct
			a.id AS "id",
			a.storname AS "storname",
			a.storname AS "stornamed",
			a.id AS "id",
			a.storcode as "storcode",
			a.sealflag as "sealflag"
		FROM llm_stordoc a
		where a.pk_corp =#{ERP_CORP_ID} and a.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY a.storcode ASC 
	</select>
		<select id="findWkList" resultType="Wk">
    SELECT
      wk.id AS "id",
      wk.gzzxmc||'('||o.name||')' AS "gzzxmc",
      wk.gzzxmc||'('||o.name||')' AS "gzzxmced",
      wk.pk_wkclassid as "pk_wkclassid",
      o.name as "office.name",
      o.id as "office.id"
    FROM llm_wk wk 
    left join sys_office o on wk.ssbmid=o.id
		where wk.pk_corp =#{ERP_CORP_ID} and wk.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY wk.gzzxbm ASC
	</select>
		<select id="getAllocateUserList" resultType="User">
		select t.id AS "id", t.name AS "name", t.office_id as "office.id"
		  from sys_user t
		  join sys_user_role t1 on t.id = t1.user_id
		  join sys_role t2 on t1.role_id = t2.id
	</select>
		<select id="getReservoirList" resultType="Office" >
		select id
		  from (select m.id
		          from sys_office m
		         start with m.id = #{id}
		        connect by prior m.parent_id = m.id
		        and m.del_flag = #{DEL_FLAG_NORMAL}
		        ) k
		 where k.id in (SELECT a.id
		                  FROM sys_office a
		                 where a.parent_id = #{WULIU_OFFICE_ID}
		                   and a.del_flag = #{DEL_FLAG_NORMAL})
	</select>
	<!-- 二级select -->
	<select id="findAllocateStoridList" resultType="Wk">
		SELECT
	      wk.id AS "id",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmc",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmced",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxbm",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxbmed",
	      wk.pk_wkclassid as "pk_wkclassid",
	      o.name as "office.name",
	      o.id as "office.id"
    FROM llm_wk wk 
    left join sys_office o on wk.ssbmid=o.id
    left join llm_wkstadoc ws on  ws.pk_wkcenter= wk.id
	
    where ws.PK_CWAREHOUSEID= #{allocStorid}
		ORDER BY wk.gzzxbm ASC
	</select>
		<select id="findAllocatedStoridList" resultType="Wk">
		SELECT
	      wk.id AS "id",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmc",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmced",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxbm",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxbmed",
	      wk.pk_wkclassid as "pk_wkclassid",
	      o.name as "office.name",
	      o.id as "office.id"
    FROM llm_wk wk 
    left join sys_office o on wk.ssbmid=o.id
    left join llm_wkstadoc ws on  ws.pk_wkcenter= wk.id
	
    where ws.PK_CWAREHOUSEID= #{allocedStorid}
		ORDER BY wk.gzzxbm ASC
	</select>
			<select id="findStorList" resultType="User">
		SELECT 
			a.id AS "id",
			a.name AS "name",
			a.office_id AS "office.id"
		FROM sys_user a
		where a.office_id = (select o.id from sys_office o where o.id=(select t.pk_reservoirid from llm_stordoc t where t.id=#{value}))
		      and a.del_flag='0'	
	</select>
</mapper>