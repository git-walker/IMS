<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.rootyu.rad.modules.stafrock.dao.StocktakingTaskDao">
<sql id="StocktakingTaskColumns">
a.id AS "id",
a.pk_invid AS "pkInvid",
a.pk_stationid AS "pkStationid",
a.pk_checker AS "pkChecker",
a.pk_assigner AS "pkAassigner",
a.pk_stordoc AS "pkStordoc",
wk.gzzxbm AS "wk.gzzxbm",
wk.gzzxmc AS "wk.gzzxmc",
wk.pk_wkclassid AS "pkWkclassid",
o.id AS "office.id",
o.name AS "office.name",
s.id AS "stordoc.id",
s.storname AS "stordoc.storname",
ibd.id AS "invbasdoc.id",
ibd.invname AS "invbasdoc.invname",
ibd.invcode AS "invbasdoc.invcode",
u.id AS "user.id",
u.name AS "user.name"
</sql>
	<sql id="StocktakingTaskJoins">
	left join sys_user u on u.id = a.pk_checker
    left join llm_wkstadoc ws on ws.id = a.pk_stationid
    left join llm_wk wk on wk.id = ws.pk_wkcenter
    left join llm_stordoc s on s.id = a.pk_stordoc
    left join llm_invbasdoc ibd on ibd.id = a.pk_invid
    left join sys_office o on  o.id=s.PK_RESERVOIRID
    
	</sql>
	<select id="get" resultType="StocktakingTask">
		SELECT 
			<include refid="StocktakingTaskColumns"/>
		FROM llm_stocktaking_task a
		<include refid="StocktakingTaskJoins"/>
		WHERE a.id = #{id}
	</select>
	    <select id="findPage" resultType="StocktakingTask">
		SELECT 
		<include refid="StocktakingTaskColumns"/>
		FROM llm_stocktaking_task a
		<include refid="StocktakingTaskJoins"/>
		WHERE a.id = #{id}
	</select>
	<select id="findList" resultType="StocktakingTask">
		SELECT 
			<include refid="StocktakingTaskColumns"/>
		FROM llm_stocktaking_task a
		<include refid="StocktakingTaskJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="pkStationid != null and pkStationid != ''">
				AND a.pk_stationid = #{pkStationid}
			</if>
			<if test="pkStordoc != null and pkStordoc != ''">
				AND a.pk_stordoc = #{pkStordoc}
			</if>
		</where>
	</select>
	<select id="checkValues" resultType="StocktakingTask" parameterType="String">
		SELECT 
			<include refid="StocktakingTaskColumns"/>
		FROM llm_stocktaking_task a
		<include refid="StocktakingTaskJoins"/>
		<where>
			a.id = #{id}
		</where>
	</select>
	<insert id="insert">
		INSERT INTO llm_stocktaking_task(
			id,
			pk_invid,
			pk_stationid,
			pk_checker,
			pk_assigner,
			pk_stordoc
		) VALUES (
			#{id},
			#{pkInvid},
			#{pkStationid},
			#{pkChecker},
			#{pkAassigner},
			#{pkStordoc}
		)
	</insert>
	<update id="update">
		UPDATE llm_stocktaking_task SET 
			pk_invid = #{pkInvid},
			pk_stationid = #{pkStationid},
			pk_checker = #{pkChecker},
			pk_assigner = #{pkAassigner}
			pk_stordoc= #{pkStordoc}
		WHERE id = #{id}
		  and del_flag = #{DEL_FLAG_NORMAL}
	</update>
	<update id="delete">
		UPDATE llm_stocktaking_task SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	<select id="findStordocList" resultType="Stordoc">
		SELECT distinct
			a.storname AS "storname",
			a.id AS "id",
			a.storcode as "storcode",
			a.sealflag as "sealflag"
		FROM llm_stordoc a
		where a.pk_corp =#{ERP_CORP_ID} and a.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY a.storcode ASC 
	</select>
	<select id="findWkList" resultType="Wk">
		SELECT
			wk.id AS "id",
			wk.gzzxbm||'('||o.name||')'  AS "gzzxbm",
			wk.gzzxmc||'('||o.name||')' AS "gzzxmc",
			wk.pk_wkclassid as "pk_wkclassid",
			o.name as "office.name",
			o.id as "office.id"
		FROM llm_wk wk 
		left join sys_office o on wk.ssbmid=o.id
		where wk.pk_corp =#{ERP_CORP_ID} and wk.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY wk.gzzxbm ASC
	</select>
	<select id="getStorUserList" resultType="User">
		select t.id, t.name, t.office_id as "office.id"
		  from sys_user t
		  join sys_user_role t1 on t.id = t1.user_id
		  join sys_role t2 on t1.role_id = t2.id
	</select>
	<select id="getReservoirList" resultType="Office" >
		select id
		  from (select m.id
		          from sys_office m
		         start with m.id = #{id}
		        connect by prior m.parent_id = m.id
		        and m.del_flag = #{DEL_FLAG_NORMAL}
		        ) k
		 where k.id in (SELECT a.id
		                  FROM sys_office a
		                 where a.parent_id = #{WULIU_OFFICE_ID}
		                   and a.del_flag = #{DEL_FLAG_NORMAL})
	</select>
	<select id= "getInvBasDocList" resultType="InvBasDoc">
		select ibd.id,ibd.invname,ibd.invcode
		from llm_invbasdoc ibd
		where ibd.pk_corp =#{ERP_CORP_ID} and ibd.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY ibd.invcode ASC 
	</select>
		<select id="findstocktakingStoridList" resultType="Wk">
		SELECT
			wk.id AS "id",
			wk.gzzxbm||'('||o.name||')'  AS "gzzxbm",
			wk.pk_wkclassid as "pk_wkclassid",
			o.name as "office.name",
			o.id as "office.id"
		FROM llm_wk wk 
		left join sys_office o on wk.ssbmid=o.id
		left join llm_wkstadoc ws on  ws.pk_wkcenter= wk.id
		where ws.PK_CWAREHOUSEID= #{pkStordoc}
		ORDER BY wk.gzzxbm ASC
	</select>
		<select id="findStorList" resultType="User">
		SELECT 
			a.id AS "id",
			a.name AS "name",
			a.office_id AS "office.id"
		FROM sys_user a
		where a.office_id = (select o.id from sys_office o where o.id=(select t.pk_reservoirid from llm_stordoc t where t.id=#{value}))
		      and a.del_flag='0'	
	</select>
</mapper>