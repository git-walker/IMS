<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.rootyu.rad.modules.stafrock.dao.BorrowTaskDao">
<sql id="BorrowTaskColumns">
a.id AS "id",
a.batchsequence AS "batchSequence",
a.batchcode AS "batchCode",
a.borrow_num AS "borrowNum",
a.borrow_stationid AS "borrowStationid",
a.borrowed_stationid AS "borrowedStationid",
a.borrow_goodid AS "borrowGoodid",
a.borrowed_goodid AS "borrowedGoodid",
a.borrow_storid AS "borrowStorid",
a.borrowed_storid AS "borrowedStorid",
a.plan_time AS "planTime",
a.actual_time AS "actualTime",
a.actual_num AS "actualNum",
a.pk_invbasdoc AS "pkInvbasdoc",
a.borrowuserid AS "borrowUserid",
a.borrow_billcode AS "borrowBillcode",
a.status_flag AS "statusFlag",
a.pk_rdcl AS "pkRdcl",
a.pk_rdcled AS "pkRdcled",
ibd.id AS "invbasdoc.id",
ibd.invname AS "invbasdoc.invname",
ibd.invcode AS "invbasdoc.invcode",
sd.id AS "stordoc.id",
sd.storname AS "stordoc.storname",
(select storname from llm_stordoc sd where sd.id=a.borrowed_storid) AS "stordoc.stornamed",
cd.id AS "cargdoc.id",
cd.name AS "cargdoc.name",
(select name from llm_cargdoc cd where cd.id=a.borrowed_goodid) AS "cargdoc.named",
wk.gzzxmc AS "wk.gzzxmc",
(select gzzxmc from llm_wk wk where wk.id=a.borrowed_stationid) AS "wk.gzzxmced",
u.name AS "user.name",
o.id AS "office.id",
o.name AS "office.name"
</sql>
<sql id="BorrowTaskJoins">
	 left join llm_invbasdoc ibd on ibd.id = a.pk_invbasdoc
	 left join llm_stordoc sd on sd.id = a.borrow_storid
	 left join llm_cargdoc cd on cd.id = a.borrow_goodid
	 left join llm_wkstadoc ws on ws.id = a.borrow_stationid
   	 left join llm_wk wk on wk.id = ws.pk_wkcenter
   	 left join sys_user u ON u.id=a.borrowuserid 
   	 left join sys_office o on  o.id=sd.PK_RESERVOIRID
	 
</sql>
<select id="get" resultType="BorrowTask">
		SELECT 
			<include refid="BorrowTaskColumns"/>
		FROM llm_borrow a
		<include refid="BorrowTaskJoins"/>
		WHERE a.id = #{id}
	</select>
	    <select id="findPage" resultType="BorrowTask">
		SELECT 
		<include refid="BorrowTaskColumns"/>
		FROM llm_borrow a
		<include refid="BorrowTaskJoins"/>
		WHERE a.id = #{id}
	</select>
	<select id="findList" resultType="BorrowTask">
		SELECT 
			<include refid="BorrowTaskColumns"/>
		FROM llm_borrow a
		<include refid="BorrowTaskJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="pkInvbasdoc != null and pkInvbasdoc != ''">
				AND a.pk_invbasdoc = #{pkInvbasdoc}
			</if>

		</where>
	</select>
	<select id="checkValues" resultType="BorrowTask" parameterType="String">
		SELECT 
			<include refid="BorrowTaskColumns"/>
		FROM llm_borrow a
		<include refid="BorrowTaskJoins"/>
		<where>
			a.id = #{id}
		</where>
	</select>
	<insert id="insert">
		INSERT INTO llm_borrow(
			id,
			batchsequence,
			batchcode,
			borrow_num,
			borrow_stationid,
			borrowed_stationid,
			borrow_goodid,
			borrowed_goodid,
			borrow_storid,
			borrowed_storid,
			plan_time,
			actual_time,
			actual_num,
			pk_invbasdoc,
			borrowuserid,
			borrow_billcode,
			status_flag,
			pk_rdcl,
			pk_rdcled
		) VALUES (
			#{id},
			#{batchSequence},
			#{batchCode},
			#{borrowNum},
			#{borrowStationid},
			#{borrowedStationid},
			#{borrowGoodid},
			#{borrowedGoodid},
			#{borrowStorid},
			#{borrowedStorid},
			#{planTime},
			#{actualTime},
			#{actualNum},
			#{pkInvbasdoc},
			#{borrowUserid},
			#{borrowBillcode},
			#{statusFlag},
			#{pkRdcl},
			#{pkRdcled}
		)
	</insert>
	<update id="update">
		UPDATE llm_borrow SET 
			batchsequence = #{batchSequence},
			batchcode = #{batchCode},
			borrow_num = #{borrowNum},
			borrow_stationid = #{borrowStationid},
			borrowed_stationid = #{borrowedStationid},
			borrow_goodid = #{borrowGoodid},
			borrowed_goodid = #{borrowedGoodid},
			borrow_storid = #{borrowStorid},
			borrowed_storid = #{borrowedStorid},
			plan_time = #{planTime},
			actual_time = #{actualTime},
			actual_num = #{actualNum},
			pk_invbasdoc = #{pkInvbasdoc},
			borrowuserid = #{borrowUserid},
			borrow_billcode = #{borrowBillcode},
			status_flag = #{statusFlag},
			pk_rdcl = #{pkRdcl},
			pk_rdcled = #{pkRdcled}
		WHERE id = #{id}
		  and del_flag = #{DEL_FLAG_NORMAL}
	</update>
	<update id="delete">
		UPDATE llm_borrow SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	<select id="getInvBasDocList" resultType="InvBasDoc">
		select ibd.id,ibd.invname,ibd.invcode
		from llm_invbasdoc ibd
		where ibd.pk_corp =#{ERP_CORP_ID} and ibd.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY ibd.invcode ASC 
	</select>
	<select id="findStordocList" resultType="Stordoc">
		SELECT distinct
			a.id AS "id",
			a.storname AS "storname",
			a.storname AS "stornamed",
			a.id AS "id",
			a.storcode as "storcode",
			a.sealflag as "sealflag"
		FROM llm_stordoc a
		where a.pk_corp =#{ERP_CORP_ID} and a.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY a.storcode ASC 
	</select>
		<select id="findWkList" resultType="Wk">
    SELECT
      wk.id AS "id",
      wk.gzzxmc||'('||o.name||')' AS "gzzxmc",
      wk.gzzxmc||'('||o.name||')' AS "gzzxmced",
      wk.pk_wkclassid as "pk_wkclassid",
      o.name as "office.name",
      o.id as "office.id"
    FROM llm_wk wk 
    left join sys_office o on wk.ssbmid=o.id
		where wk.pk_corp =#{ERP_CORP_ID} and wk.del_flag =#{DEL_FLAG_NORMAL}
		ORDER BY wk.gzzxbm ASC
	</select>
		<select id="getBorrowUserList" resultType="User">
		select t.id AS "id", t.name AS "name", t.office_id as "office.id"
		  from sys_user t
		  join sys_user_role t1 on t.id = t1.user_id
		  join sys_role t2 on t1.role_id = t2.id
	</select>
		<select id="getReservoirList" resultType="Office" >
		select id
		  from (select m.id
		          from sys_office m
		         start with m.id = #{id}
		        connect by prior m.parent_id = m.id
		        and m.del_flag = #{DEL_FLAG_NORMAL}
		        ) k
		 where k.id in (SELECT a.id
		                  FROM sys_office a
		                 where a.parent_id = #{WULIU_OFFICE_ID}
		                   and a.del_flag = #{DEL_FLAG_NORMAL})
	</select>
	<!-- 二级select -->
	<select id="findBorrowStoridList" resultType="Wk">
		SELECT
	      wk.id AS "id",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmc",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmced",
	      wk.gzzxbm||'('||o.name||')' AS "gzzxbm",
	      wk.gzzxbm||'('||o.name||')' AS "gzzxbmed",
	      wk.pk_wkclassid as "pk_wkclassid",
	      o.name as "office.name",
	      o.id as "office.id"
    FROM llm_wk wk 
    left join sys_office o on wk.ssbmid=o.id
    left join llm_wkstadoc ws on  ws.pk_wkcenter= wk.id
	
    where ws.PK_CWAREHOUSEID= #{borrowStorid}
		ORDER BY wk.gzzxbm ASC
	</select>
		<select id="findBorrowedStoridList" resultType="Wk">
		SELECT
	      wk.id AS "id",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmc",
	      wk.gzzxmc||'('||o.name||')' AS "gzzxmced",
	      wk.gzzxbm||'('||o.name||')' AS "gzzxbm",
	      wk.gzzxbm||'('||o.name||')' AS "gzzxbmed",
	      wk.pk_wkclassid as "pk_wkclassid",
	      o.name as "office.name",
	      o.id as "office.id"
    FROM llm_wk wk 
    left join sys_office o on wk.ssbmid=o.id
    left join llm_wkstadoc ws on  ws.pk_wkcenter= wk.id
	
    where ws.PK_CWAREHOUSEID= #{borrowedStorid}
		ORDER BY wk.gzzxbm ASC
	</select>
			<select id="findStorList" resultType="User">
		SELECT 
			a.id AS "id",
			a.name AS "name",
			a.office_id AS "office.id"
		FROM sys_user a
		where a.office_id = (select o.id from sys_office o where o.id=(select t.pk_reservoirid from llm_stordoc t where t.id=#{value}))
		      and a.del_flag='0'	
	</select>
</mapper>